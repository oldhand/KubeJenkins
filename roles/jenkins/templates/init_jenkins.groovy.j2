// 管理员账号配置、API Token生成（兼容旧版本Jenkins）
import hudson.model.User
import jenkins.model.Jenkins
import hudson.security.HudsonPrivateSecurityRealm
import hudson.security.FullControlOnceLoggedInAuthorizationStrategy
import hudson.security.csrf.DefaultCrumbIssuer
import jenkins.security.ApiTokenProperty
import java.util.logging.Logger
import java.util.UUID
import java.security.MessageDigest
import java.util.Locale

def logger = Logger.getLogger("init_jenkins")

def generateUuidMd5(logger) {
    try {
        UUID uuid = UUID.randomUUID()
        String uuidStr = uuid.toString()
        
        MessageDigest md = MessageDigest.getInstance("MD5")
        byte[] md5Bytes = md.digest(uuidStr.getBytes("UTF-8"))
        
        BigInteger bigInt = new BigInteger(1, md5Bytes)
        String md5Str = bigInt.toString(16).padLeft(32, '0')
        
        logger.info("生成UUID: ${uuidStr}，对应的MD5值: ${md5Str}")
        return md5Str
    } catch (Exception e) {
        logger.warning("生成UUID的MD5值失败，使用默认名称: ${e.message}")
        return "default_token"
    }
}

try {
    Jenkins instance = Jenkins.get()
    synchronized (instance) {
        // 1. 配置管理员账号
        logger.info("开始配置管理员账号...") 
        def hudsonRealm = new HudsonPrivateSecurityRealm(false)
        def adminUsername = "{{ jenkins.admin.username | default('admin') }}"
        def adminPassword = "{{ jenkins.admin.password | default('admin') }}"
        if (User.getAll().find { it.id == adminUsername } == null) {
            hudsonRealm.createAccount(adminUsername, adminPassword)
            logger.info("管理员账号 [${adminUsername}] 创建成功")
        } else {
            logger.info("管理员账号 [${adminUsername}] 已存在")
        }
        instance.setSecurityRealm(hudsonRealm)
        

        // 2. 生成API Token（核心功能）
        User adminUser = User.get(adminUsername, true)
        logger.info("为用户 [${adminUsername}] 生成API Token...")

        ApiTokenProperty tokenProperty = adminUser.getProperty(ApiTokenProperty.class)
        if (tokenProperty == null) {
            tokenProperty = new ApiTokenProperty()
            adminUser.addProperty(tokenProperty)
        }
      

        def tokenName = generateUuidMd5(logger)
        def newToken = tokenProperty.tokenStore.generateNewToken(tokenName)
        def tokenValue = newToken.plainValue
		String yamlContent = """user: ${tokenName}
token: ${tokenValue}
"""
        def tokenFile = new File("/var/jenkins_home/config.yaml")
        tokenFile.text = yamlContent
        logger.info("API Token已写入文件: ${tokenFile.absolutePath}")

        adminUser.save()

        // 3. 权限配置
        logger.info("配置管理员权限策略...")

        def strategy = new FullControlOnceLoggedInAuthorizationStrategy()
        strategy.setAllowAnonymousRead(false)
        instance.setAuthorizationStrategy(strategy)
    
        logger.info("启用CSRF保护，配置crumb生成器...")
        instance.setCrumbIssuer(new DefaultCrumbIssuer(true)) // 启用默认crumb生成器


        // 4. 简化语言配置（仅依赖系统属性）
        logger.info("设置默认语言为中文...")
        System.setProperty("user.language", "zh")
        System.setProperty("user.country", "CN")

        // 保存配置
        instance.save()
        logger.info("所有核心配置完成!!!")
    }
} catch (Exception e) {
    logger.severe("初始化脚本执行失败: ${e.getMessage()}")
    e.printStackTrace()
    try {
        Jenkins.get().save()
    } catch (Exception ex) {
        logger.severe("保存配置失败: ${ex.getMessage()}")
    }
}
